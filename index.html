<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinFamily | Smart Family Finance</title>
    <link rel="shortcut icon" href="https://img.icons8.com/?size=100&id=40516&format=png&color=000000" type="image/png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { darkBg: '#020617' }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        * { transition: background-color 0.3s ease, border-color 0.3s ease, color 0.2s ease, box-shadow 0.3s ease; }
        .glass { 
            background: rgba(255, 255, 255, 0.75); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(255, 255, 255, 0.4); 
        }
        .dark .glass { 
            background: rgba(15, 23, 42, 0.7); 
            border: 1px solid rgba(255, 255, 255, 0.08); 
        }
        .animate-fade-up { 
            animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; 
        }
        @keyframes fadeInUp { 
            from { opacity: 0; transform: translateY(20px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
    </style>
</head>
<body class="bg-slate-50 dark:bg-darkBg text-slate-900 dark:text-slate-100 min-h-screen">

    <nav class="fixed top-0 w-full z-50 glass border-b border-slate-200 dark:border-slate-800 px-6 py-4">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2 font-extrabold text-2xl tracking-tighter text-indigo-600 dark:text-indigo-400">
                <i data-lucide="wallet-2"></i> FinFamily
            </div>
            <div class="flex items-center gap-4">
                <button id="theme-btn" class="p-2.5 rounded-xl bg-slate-100 dark:bg-slate-800 hover:bg-indigo-100 dark:hover:bg-indigo-900/30 transition-all">
                    <i data-lucide="moon" id="theme-icon" class="w-5 h-5 text-slate-600 dark:text-slate-300"></i>
                </button>
                <div data-netlify-identity-button></div>
            </div>
        </div>
    </nav>

    <main class="pt-32 pb-20 px-6 max-w-7xl mx-auto">
        <div id="logged-out" class="text-center py-20 animate-fade-up">
            <span class="px-4 py-1 text-sm font-bold bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 rounded-full mb-6 inline-block">‚ú® Kelola Keuangan Keluarga</span>
            <h1 class="text-5xl md:text-7xl font-black mb-8 tracking-tight">Atur Uang Lebih <span class="text-indigo-600">Cerdas.</span></h1>
            <p class="text-lg text-slate-500 dark:text-slate-400 max-w-2xl mx-auto mb-10">Dashboard modern untuk mencatat pengeluaran, memantau anggaran, dan analisis kategori secara real-time.</p>
            <button onclick="netlifyIdentity.open()" class="bg-indigo-600 text-white px-10 py-4 rounded-2xl font-bold text-lg shadow-xl shadow-indigo-500/30 hover:scale-105 transition-all">Mulai Sekarang</button>
        </div>

        <div id="dashboard" style="display: none;" class="space-y-8 animate-fade-up">
            
            <div class="glass p-6 rounded-[2rem] mb-8 border-b-4 border-emerald-500">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-black text-xl flex items-center gap-2">
                        <i data-lucide="calendar-check" class="text-emerald-500"></i>
                        Ringkasan Tahun <span id="current-year-label"></span>
                    </h3>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-emerald-500/5 p-4 rounded-2xl">
                        <p class="text-xs text-slate-500 uppercase font-bold tracking-wider">Total Pemasukan Tahunan</p>
                        <p id="annual-income" class="text-2xl font-black text-emerald-500">Rp 0</p>
                    </div>
                    <div class="bg-rose-500/5 p-4 rounded-2xl">
                        <p class="text-xs text-slate-500 uppercase font-bold tracking-wider">Total Pengeluaran Tahunan</p>
                        <p id="annual-expense" class="text-2xl font-black text-rose-500">Rp 0</p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="glass p-8 rounded-[2rem] shadow-sm border-l-4 border-indigo-500">
                    <p class="text-slate-500 dark:text-slate-400 text-sm font-medium uppercase tracking-wider">Total Saldo (Bulan Ini)</p>
                    <h2 id="total-balance" class="text-4xl font-black mt-2 text-slate-800 dark:text-white tracking-tight">Rp 0</h2>
                </div>
                
                <div class="glass p-8 rounded-[2rem] shadow-sm relative overflow-hidden group">
                    <div class="flex justify-between items-start">
                        <p class="text-slate-500 dark:text-slate-400 text-sm font-medium uppercase tracking-wider">Batas Anggaran</p>
                        <button onclick="setBudget()" class="text-slate-400 hover:text-indigo-500 transition-colors">
                            <i data-lucide="settings" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <h2 id="budget-display" class="text-4xl font-black mt-2 tracking-tight">Rp 0</h2>
                    <div class="h-2 w-full bg-slate-200 dark:bg-slate-800 rounded-full mt-4 overflow-hidden">
                        <div id="budget-progress" class="h-full bg-indigo-500 rounded-full transition-all duration-1000" style="width: 0%"></div>
                    </div>
                    <p id="budget-status" class="text-[10px] mt-2 font-bold uppercase tracking-wider"></p>
                </div>

                <div class="glass p-8 rounded-[2rem] flex flex-col justify-center gap-3">
                    <button onclick="toggleModal()" class="w-full py-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-2xl font-bold shadow-lg shadow-indigo-500/20 transition-all">
                        + Transaksi Baru
                    </button>
                    <button id="scan-btn" onclick="document.getElementById('scan-input').click()" class="w-full py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl font-bold flex items-center justify-center gap-2 transition-all">
                        <i data-lucide="camera" class="w-4 h-4"></i> Scan Struk
                    </button>
                    <input type="file" id="scan-input" accept="image/*" class="hidden" onchange="processReceipt(event)">
                    
                    <div class="grid grid-cols-2 gap-2">
                        <button id="btn-export" onclick="exportToExcel()" class="py-2 text-emerald-600 dark:text-emerald-400 font-bold text-xs flex items-center justify-center gap-2 hover:opacity-80 transition-all">
                            <i data-lucide="file-spreadsheet" class="w-4 h-4"></i> Excel
                        </button>
                        <button id="btn-export-pdf" onclick="exportToPDF()" class="py-2 text-rose-600 dark:text-rose-400 font-bold text-xs flex items-center justify-center gap-2 hover:opacity-80 transition-all">
                            <i data-lucide="file-text" class="w-4 h-4"></i> PDF
                        </button>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="glass p-8 rounded-[2rem]">
                    <h4 class="font-bold mb-6 flex items-center gap-2 text-slate-700 dark:text-slate-200">
                        <i data-lucide="trending-up" class="text-indigo-500"></i> Tren Transaksi (Bulan Ini)
                    </h4>
                    <canvas id="mainChart" height="200"></canvas>
                </div>
                <div class="glass p-8 rounded-[2rem]">
                    <h4 class="font-bold mb-6 flex items-center gap-2 text-slate-700 dark:text-slate-200">
                        <i data-lucide="pie-chart" class="text-indigo-500"></i> Alokasi Kategori (Bulan Ini)
                    </h4>
                    <canvas id="categoryChart" height="200"></canvas>
                </div>
            </div>

            <div class="glass p-8 rounded-[2rem]">
                <h4 class="font-bold mb-6 flex items-center gap-2 text-slate-700 dark:text-slate-200">
                    <i data-lucide="bar-chart-3" class="text-indigo-500"></i> Perbandingan Pengeluaran Bulanan
                </h4>
                <div class="h-[300px]">
                    <canvas id="annualBarChart"></canvas>
                </div>
            </div>

            <div class="glass rounded-[2rem] overflow-hidden">
                <div class="p-8 border-b border-slate-100 dark:border-slate-800 flex flex-col md:flex-row justify-between items-center gap-4">
                    <h4 class="font-bold whitespace-nowrap">Riwayat Transaksi</h4>
                    <div class="flex flex-1 items-center gap-2 w-full md:max-w-md">
                        <div class="relative flex-1">
                            <i data-lucide="search" class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                            <input type="text" id="search-input" placeholder="Cari transaksi..." 
                                   class="w-full pl-10 pr-4 py-2 bg-slate-100 dark:bg-slate-800 border-none rounded-xl text-sm focus:ring-2 ring-indigo-500"
                                   oninput="filterTransactions()">
                        </div>
                        <input type="month" id="filter-month" 
                               class="bg-slate-100 dark:bg-slate-800 border-none rounded-xl text-sm p-2 focus:ring-2 ring-indigo-500"
                               onchange="refreshData()">
                    </div>
                </div>
                <div id="transaction-list" class="divide-y divide-slate-100 dark:divide-slate-800 min-h-[100px]"></div>
            </div>
        </div>
    </main>

    <div id="modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden z-[100] flex items-center justify-center p-4">
        <div class="glass max-w-md w-full p-10 rounded-[2.5rem] shadow-2xl animate-fade-up">
            <h2 class="text-3xl font-black mb-8">Transaksi Baru</h2>
            <form id="trans-form" class="space-y-5">
                <input type="text" id="desc" placeholder="Keterangan" class="w-full p-4 rounded-2xl bg-slate-100 dark:bg-slate-800 border-none outline-none focus:ring-2 ring-indigo-500 transition-all" required>
                
                <div class="grid grid-cols-2 gap-4">
                    <input type="number" id="amount" placeholder="Jumlah (Rp)" class="w-full p-4 rounded-2xl bg-slate-100 dark:bg-slate-800 border-none outline-none focus:ring-2 ring-indigo-500" required>
                    <select id="type" class="p-4 rounded-2xl bg-slate-100 dark:bg-slate-800 border-none outline-none focus:ring-2 ring-indigo-500 font-bold">
                        <option value="expense">Pengeluaran</option>
                        <option value="income">Pemasukan</option>
                    </select>
                </div>

                <select id="category" class="w-full p-4 rounded-2xl bg-slate-100 dark:bg-slate-800 border-none outline-none focus:ring-2 ring-indigo-500">
                    <option value="Makanan">üçï Makanan</option>
                    <option value="Transportasi">üöó Transportasi</option>
                    <option value="Belanja">üõçÔ∏è Belanja</option>
                    <option value="Tagihan">üßæ Tagihan</option>
                    <option value="Kesehatan">üè• Kesehatan</option>
                    <option value="Gaji">üí∞ Gaji</option>
                    <option value="Lainnya">üì¶ Lainnya</option>
                </select>

                <div class="flex gap-4 pt-6">
                    <button type="button" onclick="toggleModal()" class="flex-1 font-bold text-slate-400 hover:text-slate-600 transition-colors">Batal</button>
                    <button type="submit" class="flex-[2] py-4 bg-indigo-600 text-white rounded-2xl font-bold shadow-lg shadow-indigo-500/30 hover:bg-indigo-700 hover:scale-[1.02] active:scale-95 transition-all">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let mainChart, categoryChart, annualBarChart;
        let currentData = [];
        let selectedMonth = new Date().toISOString().substring(0, 7);

        document.getElementById('filter-month').value = selectedMonth;

        // --- THEME ENGINE ---
        function setDarkMode(isDark) {
            if (isDark) {
                document.documentElement.classList.add('dark');
                document.getElementById('theme-icon').setAttribute('data-lucide', 'sun');
                localStorage.setItem('theme', 'dark');
            } else {
                document.documentElement.classList.remove('dark');
                document.getElementById('theme-icon').setAttribute('data-lucide', 'moon');
                localStorage.setItem('theme', 'light');
            }
            if(window.lucide) lucide.createIcons();
            if (currentData.length > 0) {
                renderDashboard(currentData);
                updateAnnualBarChart();
            }
        }

        document.getElementById('theme-btn').onclick = () => {
            setDarkMode(!document.documentElement.classList.contains('dark'));
        };

        // --- AUTH LOGIC ---
        function updateUIState(user) {
            const loggedOutDiv = document.getElementById('logged-out');
            const dashboardDiv = document.getElementById('dashboard');
            
            if (user) {
                loggedOutDiv.style.display = 'none';
                dashboardDiv.style.display = 'block';
                refreshData();
                fetchAnnualSummary();
                updateAnnualBarChart();
            } else {
                loggedOutDiv.style.display = 'block';
                dashboardDiv.style.display = 'none';
            }
        }

        // --- UI FEEDBACK ---
        function showSkeleton() {
            const list = document.getElementById('transaction-list');
            const skeleton = `
                <div class="p-6 animate-pulse flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-slate-200 dark:bg-slate-800 rounded-2xl"></div>
                        <div class="space-y-2">
                            <div class="h-4 w-32 bg-slate-200 dark:bg-slate-800 rounded"></div>
                            <div class="h-3 w-20 bg-slate-100 dark:bg-slate-700 rounded"></div>
                        </div>
                    </div>
                    <div class="h-6 w-24 bg-slate-200 dark:bg-slate-800 rounded-lg"></div>
                </div>
            `.repeat(3);
            list.innerHTML = skeleton;
        }

        // --- DATA ENGINE ---
        async function refreshData() {
            const user = netlifyIdentity.currentUser();
            if (!user) return;

            showSkeleton();
            const monthFilter = document.getElementById('filter-month').value;
            selectedMonth = monthFilter;

            try {
                const token = await user.jwt();
                const res = await fetch(`/.netlify/functions/get-data?month=${monthFilter}`, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                
                if (!res.ok) throw new Error("Backend offline");
                currentData = await res.json();
                renderDashboard(currentData);
            } catch (err) {
                console.warn("Error loading data", err);
                renderDashboard([]);
            }
        }

        function filterTransactions() {
            const term = document.getElementById('search-input').value.toLowerCase();
            const filtered = currentData.filter(item => 
                item.description.toLowerCase().includes(term) || 
                item.category.toLowerCase().includes(term)
            );
            renderDashboard(filtered, true);
        }

        function renderDashboard(data, isFiltering = false) {
            const list = document.getElementById('transaction-list');
            let totalBalance = 0, totalExpense = 0, catMap = {};
            
            list.innerHTML = data.map(item => {
                const isIncome = item.type === 'income';
                const amount = parseFloat(item.amount);
                
                if (!isFiltering) {
                    totalBalance += isIncome ? amount : -amount;
                    if (!isIncome) {
                        totalExpense += amount;
                        catMap[item.category] = (catMap[item.category] || 0) + amount;
                    }
                }
                
                return `
                    <div class="p-6 flex justify-between items-center hover:bg-slate-50 dark:hover:bg-slate-800/40 group transition-colors">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 flex items-center justify-center rounded-2xl ${isIncome ? 'bg-emerald-500/10 text-emerald-500' : 'bg-rose-500/10 text-rose-500'}">
                                <i data-lucide="${isIncome ? 'trending-up' : 'trending-down'}" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <p class="font-bold text-slate-800 dark:text-slate-200 leading-none mb-1">${item.description}</p>
                                <p class="text-xs text-slate-500">${item.category} ‚Ä¢ ${new Date(item.date).toLocaleDateString('id-ID')}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <p class="font-extrabold text-lg ${isIncome ? 'text-emerald-500' : 'text-rose-500'}">
                                ${isIncome ? '+' : '-'} Rp ${amount.toLocaleString()}
                            </p>
                            <button onclick="deleteTransaction('${item._id}')" class="opacity-0 group-hover:opacity-100 p-2 text-slate-400 hover:text-rose-500 transition-all">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>`;
            }).join('') || `<div class="p-20 text-center text-slate-400">${isFiltering ? 'Transaksi tidak ditemukan.' : 'Belum ada transaksi bulan ini.'}</div>`;
            
            if (!isFiltering) {
                document.getElementById('total-balance').innerText = `Rp ${totalBalance.toLocaleString()}`;
                updateBudgetUI(totalExpense);
                updateCharts(data, catMap);
            }
            if(window.lucide) lucide.createIcons();
        }

        // --- SCAN RECEIPT ENGINE (PERBAIKAN) ---
        async function processReceipt(event) {
            const file = event.target.files[0];
            if (!file) return;

            const btn = document.getElementById('scan-btn');
            const originalText = btn.innerHTML;
            
            btn.innerHTML = `<i class="w-4 h-4 animate-spin" data-lucide="loader-2"></i> Memproses...`;
            if(window.lucide) lucide.createIcons();

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async () => {
                try {
                    const res = await fetch('/.netlify/functions/scan-receipt', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ image: reader.result })
                    });
                    
                    if (!res.ok) throw new Error("Gagal mengenali struk (Server Error)");
                    
                    const result = await res.json();

                    toggleModal();
                    document.getElementById('amount').value = result.amount || 0;
                    document.getElementById('category').value = result.category || "Lainnya";
                    document.getElementById('desc').value = "Struk " + (result.category || "Otomatis");
                    document.getElementById('type').value = "expense";
                    
                    alert(`Berhasil! Terdeteksi nominal Rp ${result.amount?.toLocaleString()} dengan kategori ${result.category}`);
                } catch (err) {
                    alert("Gagal memproses struk. Silakan periksa koneksi atau coba gambar yang lebih jelas.");
                    console.error(err);
                } finally {
                    btn.innerHTML = originalText;
                    if(window.lucide) lucide.createIcons();
                    event.target.value = ""; 
                }
            };
        }

        async function deleteTransaction(id) {
            if (!confirm("Hapus transaksi ini secara permanen?")) return;
            const user = netlifyIdentity.currentUser();
            try {
                const token = await user.jwt();
                const res = await fetch(`/.netlify/functions/delete-data?id=${id}`, {
                    method: 'DELETE',
                    headers: { Authorization: `Bearer ${token}` }
                });
                if (res.ok) {
                    refreshData();
                    fetchAnnualSummary();
                    updateAnnualBarChart();
                }
            } catch (err) { alert("Gagal menghapus."); }
        }

        // --- ANNUAL SUMMARY ---
        async function fetchAnnualSummary() {
            const user = netlifyIdentity.currentUser();
            const year = new Date().getFullYear();
            document.getElementById('current-year-label').innerText = year;

            try {
                const token = await user.jwt();
                const res = await fetch(`/.netlify/functions/get-annual-summary?year=${year}`, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                const data = await res.json();

                let income = 0, expense = 0;
                if (data.totals) {
                    data.totals.forEach(t => {
                        if (t._id === 'income') income = t.total;
                        if (t._id === 'expense') expense = t.total;
                    });
                }

                document.getElementById('annual-income').innerText = `Rp ${income.toLocaleString()}`;
                document.getElementById('annual-expense').innerText = `Rp ${expense.toLocaleString()}`;
            } catch (err) { console.error(err); }
        }

        async function updateAnnualBarChart() {
            const user = netlifyIdentity.currentUser();
            if (!user) return;
            const year = new Date().getFullYear();
            const isDark = document.documentElement.classList.contains('dark');

            try {
                const token = await user.jwt();
                const res = await fetch(`/.netlify/functions/get-annual-summary?year=${year}`, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                const data = await res.json();

                const monthlyTotals = new Array(12).fill(0);
                if (data.monthlyExpense) {
                    data.monthlyExpense.forEach(item => {
                        const monthIndex = parseInt(item._id) - 1;
                        monthlyTotals[monthIndex] = item.total;
                    });
                }

                const ctx = document.getElementById('annualBarChart').getContext('2d');
                if (annualBarChart) annualBarChart.destroy();

                annualBarChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'],
                        datasets: [{
                            data: monthlyTotals,
                            backgroundColor: isDark ? '#6366f1' : '#4f46e5',
                            borderRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { 
                                beginAtZero: true,
                                grid: { color: isDark ? '#1e293b' : '#f1f5f9' },
                                ticks: { color: isDark ? '#94a3b8' : '#64748b' }
                            },
                            x: { grid: { display: false }, ticks: { color: isDark ? '#94a3b8' : '#64748b' } }
                        }
                    }
                });
            } catch (err) { console.error(err); }
        }

        // --- BUDGET UI ---
        function updateBudgetUI(exp) {
            const limit = parseFloat(localStorage.getItem('monthly_budget')) || 0;
            const pct = limit > 0 ? (exp / limit) * 100 : 0;
            
            document.getElementById('budget-display').innerText = `Rp ${limit.toLocaleString()}`;
            document.getElementById('budget-progress').style.width = `${Math.min(pct, 100)}%`;
            
            const progressBar = document.getElementById('budget-progress');
            if (pct >= 100) progressBar.className = "h-full bg-rose-500 transition-all";
            else if (pct >= 80) progressBar.className = "h-full bg-amber-500 transition-all";
            else progressBar.className = "h-full bg-indigo-500 transition-all";

            const status = document.getElementById('budget-status');
            if (limit === 0) {
                status.innerText = "Set anggaran bulanan Anda";
                status.className = "text-[10px] mt-2 font-bold uppercase text-slate-400";
            } else {
                status.innerText = pct >= 100 ? "‚ö†Ô∏è Melebihi Batas!" : "Anggaran Aman";
                status.className = `text-[10px] mt-2 font-bold uppercase ${pct >= 100 ? 'text-rose-500 animate-pulse' : 'text-emerald-500'}`;
            }
        }

        // --- CHARTS ---
        function updateCharts(data, catMap) {
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#94a3b8' : '#64748b';

            const ctx1 = document.getElementById('mainChart').getContext('2d');
            if (mainChart) mainChart.destroy();
            const last7 = [...data].reverse().slice(-7);
            
            mainChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: last7.map(d => new Date(d.date).toLocaleDateString('id-ID', {day: 'numeric', month: 'short'})),
                    datasets: [{ 
                        data: last7.map(d => d.amount), 
                        borderColor: '#6366f1', 
                        tension: 0.4, 
                        fill: true, 
                        backgroundColor: isDark ? 'rgba(99, 102, 241, 0.1)' : 'rgba(99, 102, 241, 0.05)'
                    }]
                },
                options: { 
                    responsive: true,
                    plugins: { legend: { display: false } }, 
                    scales: { 
                        x: { grid: { display: false }, ticks: { color: textColor } }, 
                        y: { display: false } 
                    } 
                }
            });

            const ctx2 = document.getElementById('categoryChart').getContext('2d');
            if (categoryChart) categoryChart.destroy();
            
            const cats = Object.keys(catMap);
            categoryChart = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: cats.length ? cats : ['No Data'],
                    datasets: [{ 
                        data: cats.length ? Object.values(catMap) : [1], 
                        backgroundColor: ['#6366f1', '#ec4899', '#f59e0b', '#10b981', '#ef4444', '#64748b'],
                        borderWidth: 0
                    }]
                },
                options: { cutout: '75%', plugins: { legend: { position: 'bottom', labels: { color: textColor } } } }
            });
        }

        // --- EXPORT ENGINES ---
        function exportToExcel() {
            if (currentData.length === 0) return alert("Tidak ada data untuk diekspor");
            const reportData = currentData.map(item => ({
                Tanggal: new Date(item.date).toLocaleDateString('id-ID'),
                Keterangan: item.description,
                Kategori: item.category,
                Tipe: item.type === 'income' ? 'Pemasukan' : 'Pengeluaran',
                Jumlah: item.amount
            }));
            const ws = XLSX.utils.json_to_sheet(reportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Transaksi");
            XLSX.writeFile(wb, `FinFamily_${selectedMonth}.xlsx`);
        }

        async function exportToPDF() {
            if (currentData.length === 0) return alert("Tidak ada data untuk diekspor");
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(20);
            doc.setTextColor(79, 70, 229); 
            doc.text("FinFamily | Laporan Keuangan", 14, 20);
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text(`Periode Bulan: ${selectedMonth}`, 14, 28);
            let totalInc = 0, totalExp = 0, tableRows = [];
            currentData.forEach(item => {
                const amount = parseFloat(item.amount);
                if (item.type === 'income') totalInc += amount; else totalExp += amount;
                tableRows.push([new Date(item.date).toLocaleDateString('id-ID'), item.description, item.category, item.type === 'income' ? 'Pemasukan' : 'Pengeluaran', `Rp ${amount.toLocaleString('id-ID')}`]);
            });
            doc.autoTable({ 
                head: [['Tanggal', 'Keterangan', 'Kategori', 'Tipe', 'Jumlah']], 
                body: tableRows, 
                startY: 40, 
                theme: 'striped', 
                headStyles: { fillGray: [79, 70, 229], textColor: 255 }, 
                columnStyles: { 4: { halign: 'right' } } 
            });
            const finalY = doc.lastAutoTable.finalY + 10;
            doc.text(`Total Pemasukan: Rp ${totalInc.toLocaleString()}`, 14, finalY);
            doc.text(`Total Pengeluaran: Rp ${totalExp.toLocaleString()}`, 14, finalY + 7);
            doc.text(`Sisa Saldo: Rp ${(totalInc - totalExp).toLocaleString()}`, 14, finalY + 14);
            doc.save(`FinFamily_Laporan_${selectedMonth}.pdf`);
        }

        // --- UI ACTIONS ---
        function toggleModal() { document.getElementById('modal').classList.toggle('hidden'); }
        function setBudget() {
            const b = prompt("Atur Batas Anggaran (Rp):", "5000000");
            if (b !== null) { localStorage.setItem('monthly_budget', b); refreshData(); }
        }

        document.getElementById('trans-form').onsubmit = async (e) => {
            e.preventDefault();
            const user = netlifyIdentity.currentUser();
            const payload = {
                description: document.getElementById('desc').value,
                amount: parseFloat(document.getElementById('amount').value),
                type: document.getElementById('type').value,
                category: document.getElementById('category').value,
                date: new Date().toISOString()
            };
            try {
                const token = await user.jwt();
                await fetch('/.netlify/functions/post-data', {
                    method: 'POST',
                    headers: { Authorization: `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                toggleModal(); e.target.reset(); refreshData(); fetchAnnualSummary(); updateAnnualBarChart();
            } catch (err) { alert("Gagal menyimpan."); }
        };

        // --- INIT ---
        const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        setDarkMode(savedTheme === 'dark');
        netlifyIdentity.on('init', user => updateUIState(user));
        netlifyIdentity.on('login', user => { updateUIState(user); netlifyIdentity.close(); });
        netlifyIdentity.on('logout', () => location.reload());
    </script>
</body>
</html>