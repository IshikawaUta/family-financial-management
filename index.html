<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinFamily | Smart Family Finance</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        // Tailwind Configuration untuk mendukung Dark Mode class-based
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        darkBg: '#020617',
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
        }

        /* Transisi halus untuk semua perubahan warna */
        * {
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.2s ease, box-shadow 0.3s ease;
        }

        .glass { 
            background: rgba(255, 255, 255, 0.75); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(255, 255, 255, 0.4); 
        }

        .dark .glass { 
            background: rgba(15, 23, 42, 0.7); 
            border: 1px solid rgba(255, 255, 255, 0.08); 
        }

        .animate-fade-up { 
            animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; 
        }

        @keyframes fadeInUp { 
            from { opacity: 0; transform: translateY(20px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        /* Menghilangkan scrollbar tapi tetap bisa scroll */
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-darkBg text-slate-900 dark:text-slate-100 min-h-screen">

    <nav class="fixed top-0 w-full z-50 glass border-b border-slate-200 dark:border-slate-800 px-6 py-4">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2 font-extrabold text-2xl tracking-tighter text-indigo-600 dark:text-indigo-400">
                <i data-lucide="wallet-2"></i> FinFamily
            </div>
            <div class="flex items-center gap-4">
                <button id="theme-btn" class="p-2.5 rounded-xl bg-slate-100 dark:bg-slate-800 hover:bg-indigo-100 dark:hover:bg-indigo-900/30 transition-all">
                    <i data-lucide="moon" id="theme-icon" class="w-5 h-5 text-slate-600 dark:text-slate-300"></i>
                </button>
                <div data-netlify-identity-button></div>
            </div>
        </div>
    </nav>

    <main class="pt-32 pb-20 px-6 max-w-7xl mx-auto">
        <div id="logged-out" class="text-center py-20 animate-fade-up">
            <span class="px-4 py-1 text-sm font-bold bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 rounded-full mb-6 inline-block">‚ú® Kelola Keuangan Keluarga</span>
            <h1 class="text-5xl md:text-7xl font-black mb-8 tracking-tight">Atur Uang Lebih <span class="text-indigo-600">Cerdas.</span></h1>
            <p class="text-lg text-slate-500 dark:text-slate-400 max-w-2xl mx-auto mb-10">Dashboard modern untuk mencatat pengeluaran, memantau anggaran, dan analisis kategori secara real-time.</p>
            <button onclick="netlifyIdentity.open()" class="bg-indigo-600 text-white px-10 py-4 rounded-2xl font-bold text-lg shadow-xl shadow-indigo-500/30 hover:scale-105 transition-all">Mulai Sekarang</button>
        </div>

        <div id="dashboard" class="hidden space-y-8 animate-fade-up">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="glass p-8 rounded-[2rem] shadow-sm">
                    <p class="text-slate-500 dark:text-slate-400 text-sm font-medium uppercase tracking-wider">Total Saldo</p>
                    <h2 id="total-balance" class="text-4xl font-black mt-2 text-indigo-600 dark:text-emerald-400 tracking-tight">Rp 0</h2>
                </div>
                
                <div class="glass p-8 rounded-[2rem] shadow-sm relative overflow-hidden group">
                    <div class="flex justify-between items-start">
                        <p class="text-slate-500 dark:text-slate-400 text-sm font-medium uppercase tracking-wider">Batas Anggaran</p>
                        <button onclick="setBudget()" class="text-slate-400 hover:text-indigo-500 transition-colors">
                            <i data-lucide="settings" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <h2 id="budget-display" class="text-4xl font-black mt-2 tracking-tight">Rp 0</h2>
                    <div class="h-2 w-full bg-slate-200 dark:bg-slate-800 rounded-full mt-4">
                        <div id="budget-progress" class="h-full bg-indigo-500 rounded-full transition-all duration-1000" style="width: 0%"></div>
                    </div>
                    <p id="budget-status" class="text-[10px] mt-2 font-bold uppercase tracking-wider"></p>
                </div>

                <div class="glass p-8 rounded-[2rem] flex flex-col justify-center gap-3">
                    <button onclick="toggleModal()" class="w-full py-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-2xl font-bold shadow-lg shadow-indigo-500/20 transition-all">
                        + Transaksi Baru
                    </button>
                    <button onclick="exportToExcel()" class="w-full py-2 text-emerald-600 dark:text-emerald-400 font-bold text-sm flex items-center justify-center gap-2 hover:opacity-80">
                        <i data-lucide="download" class="w-4 h-4"></i> Ekspor Excel
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="glass p-8 rounded-[2rem]">
                    <h4 class="font-bold mb-6 flex items-center gap-2"><i data-lucide="trending-up" class="text-indigo-500"></i> Tren 7 Hari Terakhir</h4>
                    <canvas id="mainChart" height="200"></canvas>
                </div>
                <div class="glass p-8 rounded-[2rem]">
                    <h4 class="font-bold mb-6 flex items-center gap-2"><i data-lucide="pie-chart" class="text-indigo-500"></i> Alokasi Kategori</h4>
                    <canvas id="categoryChart" height="200"></canvas>
                </div>
            </div>

            <div class="glass rounded-[2rem] overflow-hidden">
                <div class="p-8 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center">
                    <h4 class="font-bold">Riwayat Transaksi</h4>
                    <i data-lucide="history" class="w-5 h-5 text-slate-400"></i>
                </div>
                <div id="transaction-list" class="divide-y divide-slate-100 dark:divide-slate-800">
                    </div>
            </div>
        </div>
    </main>

    <div id="modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden z-[100] flex items-center justify-center p-4">
        <div class="glass max-w-md w-full p-10 rounded-[2.5rem] shadow-2xl animate-fade-up">
            <h2 class="text-3xl font-black mb-8">Transaksi Baru</h2>
            <form id="trans-form" class="space-y-5">
                <input type="text" id="desc" placeholder="Keterangan" class="w-full p-4 rounded-2xl bg-slate-100 dark:bg-slate-800 border-none outline-none focus:ring-2 ring-indigo-500 transition-all" required>
                
                <div class="grid grid-cols-2 gap-4">
                    <input type="number" id="amount" placeholder="Jumlah" class="w-full p-4 rounded-2xl bg-slate-100 dark:bg-slate-800 border-none outline-none focus:ring-2 ring-indigo-500" required>
                    <select id="type" class="p-4 rounded-2xl bg-slate-100 dark:bg-slate-800 border-none outline-none focus:ring-2 ring-indigo-500">
                        <option value="expense">Pengeluaran</option>
                        <option value="income">Pemasukan</option>
                    </select>
                </div>

                <select id="category" class="w-full p-4 rounded-2xl bg-slate-100 dark:bg-slate-800 border-none outline-none focus:ring-2 ring-indigo-500">
                    <option value="Makanan">üçï Makanan</option>
                    <option value="Transportasi">üöó Transportasi</option>
                    <option value="Belanja">üõçÔ∏è Belanja</option>
                    <option value="Tagihan">üßæ Tagihan</option>
                    <option value="Kesehatan">üè• Kesehatan</option>
                    <option value="Lainnya">üì¶ Lainnya</option>
                </select>

                <div class="flex gap-4 pt-6">
                    <button type="button" onclick="toggleModal()" class="flex-1 font-bold text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">Batal</button>
                    <button type="submit" class="flex-[2] py-4 bg-indigo-600 text-white rounded-2xl font-bold shadow-lg shadow-indigo-500/30 hover:bg-indigo-700 transition-all">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let mainChart, categoryChart;

        // --- SISTEM TEMA ---
        const themeBtn = document.getElementById('theme-btn');
        const themeIcon = document.getElementById('theme-icon');

        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            if (savedTheme === 'dark' || (!savedTheme && systemPrefersDark)) {
                setDarkMode(true);
            } else {
                setDarkMode(false);
            }
        }

        function setDarkMode(isDark) {
            if (isDark) {
                document.documentElement.classList.add('dark');
                themeIcon.setAttribute('data-lucide', 'sun');
                localStorage.setItem('theme', 'dark');
            } else {
                document.documentElement.classList.remove('dark');
                themeIcon.setAttribute('data-lucide', 'moon');
                localStorage.setItem('theme', 'light');
            }
            lucide.createIcons();
            if (mainChart) updateChartColors(); // Update chart jika warna berubah
        }

        themeBtn.onclick = () => {
            const isDark = !document.documentElement.classList.contains('dark');
            setDarkMode(isDark);
        };

        // --- UI & LOGIC ---
        function toggleModal() { 
            document.getElementById('modal').classList.toggle('hidden'); 
        }

        function setBudget() {
            const b = prompt("Masukkan Batas Anggaran Bulanan (Rp):", "5000000");
            if (b) { 
                localStorage.setItem('monthly_budget', b); 
                // Jika user sudah login, refresh tampilan
                if (netlifyIdentity.currentUser()) refreshData();
            }
        }

        async function refreshData() {
            const user = netlifyIdentity.currentUser();
            if (!user) return;
            
            try {
                const token = await user.jwt();
                // Opsional: Jika backend belum ada, gunakan data dummy/localStorage untuk demo
                const res = await fetch('/.netlify/functions/get-data', { 
                    headers: { Authorization: `Bearer ${token}` } 
                });
                const data = await res.json();
                renderDashboard(data);
            } catch (err) {
                console.error("Gagal memuat data:", err);
                // Placeholder render untuk tampilan awal
                renderDashboard([]);
            }
        }

        function renderDashboard(data) {
            const list = document.getElementById('transaction-list');
            let totalBalance = 0, totalExpense = 0, catMap = {};
            
            list.innerHTML = data.map(item => {
                const isIncome = item.type === 'income';
                const amount = parseFloat(item.amount);
                totalBalance += isIncome ? amount : -amount;
                if (!isIncome) {
                    totalExpense += amount;
                    catMap[item.category] = (catMap[item.category] || 0) + amount;
                }

                return `
                    <div class="p-6 flex justify-between items-center hover:bg-slate-50 dark:hover:bg-slate-800/40 transition-colors">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 flex items-center justify-center rounded-2xl ${isIncome ? 'bg-emerald-500/10 text-emerald-500' : 'bg-rose-500/10 text-rose-500'}">
                                <i data-lucide="${isIncome ? 'trending-up' : 'trending-down'}" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <p class="font-bold leading-none mb-1 text-slate-800 dark:text-slate-200">${item.description}</p>
                                <p class="text-xs text-slate-500 dark:text-slate-400">${item.category} ‚Ä¢ ${new Date(item.date || Date.now()).toLocaleDateString('id-ID')}</p>
                            </div>
                        </div>
                        <p class="font-extrabold text-lg ${isIncome ? 'text-emerald-500' : 'text-rose-500'}">
                            ${isIncome ? '+' : '-'} Rp ${amount.toLocaleString()}
                        </p>
                    </div>
                `;
            }).join('') || '<div class="p-20 text-center"><p class="text-slate-400">Belum ada transaksi.</p></div>';
            
            document.getElementById('total-balance').innerText = `Rp ${totalBalance.toLocaleString()}`;
            updateBudgetUI(totalExpense);
            updateCharts(data, catMap);
            lucide.createIcons();
        }

        function updateBudgetUI(exp) {
            const limit = parseFloat(localStorage.getItem('monthly_budget')) || 0;
            const pct = limit > 0 ? (exp / limit) * 100 : 0;
            document.getElementById('budget-display').innerText = `Rp ${limit.toLocaleString()}`;
            document.getElementById('budget-progress').style.width = `${Math.min(pct, 100)}%`;
            
            const status = document.getElementById('budget-status');
            if (limit === 0) {
                status.innerText = "Set anggaran di ‚öôÔ∏è";
                status.className = "text-[10px] mt-2 font-bold uppercase tracking-wider text-slate-400";
            } else if (pct >= 100) { 
                status.innerText = "‚ö†Ô∏è Melebihi Anggaran!"; 
                status.className = "text-[10px] mt-2 font-bold uppercase tracking-wider text-rose-500 animate-pulse";
            } else if (pct >= 80) {
                status.innerText = "Hati-hati: Hampir Habis";
                status.className = "text-[10px] mt-2 font-bold uppercase tracking-wider text-amber-500";
            } else {
                status.innerText = "Anggaran Aman";
                status.className = "text-[10px] mt-2 font-bold uppercase tracking-wider text-emerald-500";
            }
        }

        function updateCharts(data, catMap) {
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#94a3b8' : '#64748b';

            // Line Chart
            const ctx1 = document.getElementById('mainChart').getContext('2d');
            if (mainChart) mainChart.destroy();
            
            const last7 = [...data].slice(-7);
            mainChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: last7.length ? last7.map(d => new Date(d.date || Date.now()).getDate()) : ['-'],
                    datasets: [{ 
                        data: last7.map(d => d.amount), 
                        borderColor: '#6366f1', 
                        borderWidth: 3,
                        tension: 0.4, 
                        fill: true, 
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        pointRadius: 0
                    }]
                },
                options: { 
                    responsive: true,
                    plugins: { legend: { display: false } }, 
                    scales: { 
                        y: { display: false }, 
                        x: { 
                            grid: { display: false },
                            ticks: { color: textColor }
                        } 
                    } 
                }
            });

            // Doughnut Chart
            const ctx2 = document.getElementById('categoryChart').getContext('2d');
            if (categoryChart) categoryChart.destroy();
            
            const cats = Object.keys(catMap);
            categoryChart = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: cats.length ? cats : ['Belum ada data'],
                    datasets: [{ 
                        data: cats.length ? Object.values(catMap) : [1], 
                        backgroundColor: ['#6366f1', '#ec4899', '#f59e0b', '#10b981', '#ef4444', '#64748b'], 
                        borderWidth: 0,
                        hoverOffset: 10
                    }]
                },
                options: { 
                    cutout: '70%', 
                    plugins: { 
                        legend: { 
                            position: 'bottom',
                            labels: { color: textColor, padding: 20, font: { family: 'Plus Jakarta Sans', weight: 'bold' } }
                        } 
                    } 
                }
            });
        }

        function exportToExcel() {
            const items = Array.from(document.querySelectorAll('#transaction-list > div'));
            if (items.length === 0) return alert("Tidak ada data untuk diekspor");

            const data = items.map(el => ({
                Keterangan: el.querySelector('.font-bold').innerText,
                Info: el.querySelector('.text-xs').innerText,
                Jumlah: el.querySelector('.font-extrabold').innerText
            }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Keuangan");
            XLSX.writeFile(wb, `FinFamily_Laporan_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        document.getElementById('trans-form').onsubmit = async (e) => {
            e.preventDefault();
            const user = netlifyIdentity.currentUser();
            if (!user) return alert("Silakan login terlebih dahulu");

            const payload = {
                description: document.getElementById('desc').value,
                amount: parseFloat(document.getElementById('amount').value),
                type: document.getElementById('type').value,
                category: document.getElementById('category').value,
                date: new Date().toISOString()
            };

            try {
                const token = await user.jwt();
                await fetch('/.netlify/functions/post-data', {
                    method: 'POST',
                    headers: { Authorization: `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                toggleModal(); 
                e.target.reset(); 
                refreshData();
            } catch (err) {
                console.error("Gagal simpan:", err);
                alert("Gagal menyimpan transaksi. Pastikan Netlify Functions aktif.");
            }
        };

        // --- INIT ---
        initTheme();
        lucide.createIcons();

        netlifyIdentity.on('init', user => {
            if (user) {
                document.getElementById('logged-out').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                refreshData();
            }
        });

        netlifyIdentity.on('login', user => {
            document.getElementById('logged-out').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            refreshData();
        });

        netlifyIdentity.on('logout', () => location.reload());
    </script>
</body>
</html>